<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Management</title>
    <link rel="stylesheet" href="https://cdn.staticfile.org/element-ui/2.15.14/theme-chalk/index.min.css">
    <title>Log Query App</title>
    <!-- 引入 Vue 2 的 CDN -->
    <script src="https://cdn.staticfile.org/vue/2.2.2/vue.min.js"></script>
    <!-- 引入 Md5 的 CDN -->
    <script src="https://cdn.staticfile.org/blueimp-md5/2.12.0/js/md5.min.js"></script>
    <!-- 引入 AXIOS 的 CDN -->
    <script src="https://cdn.staticfile.org/axios/1.6.2/axios.js"></script>
    <!-- 引入组件库 -->
    <script src="https://cdn.staticfile.org/element-ui/2.15.14/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/spark-md5@3"></script>

</head>
<body>
<div id="app">
    <h1>File Management</h1>

    <!-- 文件上传表单 -->
    <el-form :model="uploadForm" label-width="80px" @submit.native.prevent="uploadFile">
        <el-form-item label="Server Name" required>
            <el-input v-model="uploadForm.serverName"></el-input>
        </el-form-item>
        <el-form-item label="File Hash" required>
            <el-input v-model="uploadForm.hash"></el-input>
        </el-form-item>
        <el-form-item label="File" required>
            <el-upload
                    :show-file-list="true"
                    :on-change="handleFileChange"
                    :auto-upload="false"
                    action="/upload"
            >
                <el-button slot="trigger" size="small">Choose File</el-button>
            </el-upload>
        </el-form-item>
        <el-form-item>
            <el-button type="primary" native-type="submit">Upload</el-button>
        </el-form-item>
    </el-form>

    <!-- 服务器列表 -->
    <ul>
        <li v-for="server in serverList" :key="server">
            {{ server }}
            <el-button type="danger" @click="restartServer(server)">Restart</el-button>
        </li>
    </ul>

    <el-button type="danger" @click="restartServer('SimpTestServer')">Restart</el-button>

</div>

<script>
    new Vue({
        el: '#app',
        data: {
            uploadForm: {
                serverName: '',
                hash: '',
                file: null,
            },
            serverList: [],
        },
        methods: {
            handleFileChange(file) {
                this.uploadForm.file = file.raw;
            },
            uploadFile() {
                const formData = new FormData();
                formData.append('serverName', this.uploadForm.serverName);
                formData.append('hash', this.uploadForm.hash);
                formData.append('file', this.uploadForm.file);

                axios.post('/upload', formData)
                    .then(response => {
                        console.log(response.data);
                        this.uploadForm = {
                            serverName: '',
                            hash: '',
                            file: null,
                        };
                    })
                    .catch(error => {
                        console.error(error);
                    });
            },
            restartServer(serverName) {
                const data = {
                    fileName: 'childservice', // replace with actual file name
                    serverName: serverName,
                };

                axios.post('/test/restart', data)
                    .then(response => {
                        console.log(response.data);
                    })
                    .catch(error => {
                        console.error(error);
                    });
            },
            fetchServerList() {
                axios.post('/servers')
                    .then(response => {
                        this.serverList = response.data.data;
                    })
                    .catch(error => {
                        console.error(error);
                    });
            },
        },
        mounted() {
            // Fetch initial server list
            this.fetchServerList();
        },
    });
</script>
</body>
</html>
