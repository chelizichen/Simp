<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimpCloud</title>
    <!-- 引入 Vue 2 的 CDN -->
    <script src="/simpserver/static/source/vue.min.js"></script>
    <!-- 引入 Md5 的 CDN -->
    <script src="/simpserver/static/source/md5.min.js"></script>
    <!-- 引入 AXIOS 的 CDN -->
    <script src="/simpserver/static/source/axios.js"></script>
    <!-- 引入组件库 -->
    <script src="/simpserver/static/source/element.js"></script>
    <link rel="stylesheet" href="/simpserver/static/source/element.css">
    <link rel="shortcut icon" href="/simpserver/static/source/Icon.jpg">
    <style>
        .like {
            cursor: pointer;
            font-size: 25px;
            display: inline-block;
        }

        * {
            margin: 0;
            padding: 0;
            font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
        }

        .flex-item {
            text-align: center;
            width: 15%;
            padding: 10px;
        }

        .el-button--primary {
            background-color: rgb(207, 15, 124);
            border-color: rgb(207, 15, 124);
        }

        .el-button--text {
            color: rgb(207, 15, 124)
        }

        .el-button--primary:focus,
        .el-button--primary:hover {
            background-color: rgb(110, 14, 69);
            border-color: rgb(110, 14, 69);
            transition: 0.5s;
        }

        .el-button--success {
            background-color: #075916;
            border-color: #075916;
        }

        .el-button--success:focus,
        .el-button--success:hover {
            background-color: #19b836;
            border-color: #19b836;
            transition: 0.5s;
        }

        .el-tabs__item.is-active {
            color: rgb(207, 15, 124)
        }

        .el-tabs__active-bar {
            background-color: rgb(207, 15, 124)
        }

        @media screen and (min-width: 200px) and (max-width: 900px) { 
            .app-not-show{
                display: none;
            }
            .app-small-size{
                font-size: 12px !important;
            }
            .app-bigger-size{
                font-size: 14px !important;
            }
            .app-text-center{
                text-align: center;
            }
            *{
                font-size: 12px;
            }
        }
    </style>
</head>

<body>
    <div id="app">
        <el-col :span="4" style="height: 100vh;box-sizing: border-box;border-right: 1px solid #EBEEF5">
            <h1 style="color: rgb(207, 15, 124);text-align: center;font-family: fantasy;" class="app-bigger-size">
                <i class="el-icon-help app-bigger-size" style="color: rgb(207, 90, 124);font-size: 36px;"></i>Simp
            </h1>
            <el-menu class="el-menu-vertical-demo" active-text-color="rgb(207, 15, 124)" style="border: none">
                <el-menu-item v-for="(item,index) in serverList " class="app-text-center" :index="item" :key="index" @click="handleOpen(item)">
                    <i class="el-icon-menu app-not-show"></i>
                    <span slot="title">{{item}}</span>
                </el-menu-item>
            </el-menu>
        </el-col>
        <el-col :span="20">
            <el-card shadow="hover">
                <div style="height: 70px;display: flex;align-items: center;justify-content: space-around;">
                    <div class="flex-item">
                        <div @click="createServerVisible = true" style="color: rgb(207, 15, 124);cursor: pointer;">
                            CreateServer</div>
                    </div>
                    <div class="flex-item">
                        <div @click="GetMainLogList()" style="color: rgb(207, 15, 124);cursor: pointer;">CheckLog</div>
                    </div>
                    <div class="flex-item">
                        <div style="font-weight: 700;">ServerCounts</div>
                        <div style="color: rgb(207, 15, 124);">{{serverList.length}}</div>
                    </div>
                </div>
            </el-card>
            <el-card shadow="hover" v-if="!serverName">
                <div style="display: flex;height: 700px;" v-if="activeName=='logger'">
                    <div style="width: 13%;margin-right: 2%;">
                        <el-select v-model="loggerFile">
                            <el-option v-for="item in mainLogList" :key="item" :value="item" :label="item"></el-option>
                        </el-select>
                        <br />
                        <br />
                        <el-input v-model="pattern"></el-input>
                        <br />
                        <br />
                        <el-button @click="GetServerLogger()" type="primary">Search</el-button>
                    </div>
                    <div class="resu"
                        style="background-color: black;height: 700px;padding: 5px 10px;width: 85%;overflow: scroll;">
                        <div style="color: aliceblue;">SimpMainControlLogServer :: {{ serverName }} :: created By leeks
                        </div>
                        <div style="color: aliceblue;margin: 2px;" v-for="item in logger">{{ item }}</div>
                    </div>
                </div>
            </el-card>
            <el-card shadow="hover" v-if="serverName">
                <div style="height: 70px;display: flex;align-items: center;justify-content: space-around;">

                    <div class="flex-item ">
                        <div style="font-weight: 700;">PackageCounts</div>
                        <div style="color: rgb(207, 15, 124);">{{packageList.length}}</div>
                    </div>
                    <div class="flex-item ">
                        <div style="font-weight: 700;">ServerName</div>
                        <div style="color: rgb(207, 15, 124);cursor: pointer;" @click="showConfig()">{{serverName ||
                            '--'}}</div>
                    </div>
                    <div class="flex-item ">
                        <div style="font-weight: 700;">Pid</div>
                        <div style="color: rgb(207, 15, 124);">{{status.pid || '--'}}</div>
                    </div>
                    <div class="flex-item ">
                        <div style="font-weight: 700;">Status</div>
                        <div style="color: rgb(207, 15, 124);">{{status.status || '--'}}</div>
                    </div>
                    <div class="flex-item ">
                        <div @click="uploadVisible = true" style="color: rgb(207, 15, 124);cursor: pointer;">Upload
                        </div>
                    </div>
                    <div class="flex-item ">
                        <div @click="ShutDownServer()" style="color: rgb(207, 15, 124);cursor: pointer;">Shutdown</div>
                    </div>

                    <div class="flex-item ">
                        <div @click="releaseVisible=true" style="color: rgb(207, 15, 124);cursor: pointer;">Release
                        </div>
                    </div>

                </div>
            </el-card>
            <el-card shadow="hover" v-if="serverName" style="padding: 0;">
                <el-tabs v-model="activeName">
                    <el-tab-pane label="logger" name="logger">
                        <div style="display: flex;height: 700px;" v-if="activeName=='logger'">
                            <div style="width: 13%;margin-right: 2%;">
                                <el-select v-model="loggerFile">
                                    <el-option v-for="item in loggerList" :key="item" :value="item"
                                        :label="item"></el-option>
                                </el-select>
                                <br />
                                <br />
                                <el-input v-model="pattern"></el-input>
                                <br />
                                <br />
                                <el-button @click="GetServerLogger()" type="primary">Search</el-button>
                            </div>
                            <div class="resu"
                                style="background-color: black;height: 700px;padding: 5px 10px;width: 85%;overflow: scroll;">
                                <div style="color: aliceblue;">SimpLogServer :: {{ serverName }} :: created By leeks
                                </div>
                                <div style="color: aliceblue;margin: 2px;" v-for="item in logger">{{ item }}</div>
                            </div>
                        </div>
                    </el-tab-pane>
                    <el-tab-pane label="api" name="api">
                        <div v-if="activeName=='api'">
                            <div v-for="item in apis">
                                <div
                                    style="display: flex;align-items: center;justify-content: space-between;margin: 5px;">
                                    <el-button type="text">{{item.method}} | {{item.path}}</el-button>
                                    <el-button type="primary">invoke</el-button>
                                </div>
                            </div>
                        </div>
                    </el-tab-pane>
                    <el-tab-pane label="doc" name="doc">
                        <div v-if="activeName=='doc'">
                            <div>
                                {{ doc }}
                            </div>
                        </div>
                    </el-tab-pane>
                </el-tabs>
            </el-card>
            <!-- 文件上传表单 -->
            <el-dialog append-to-body :visible="uploadVisible" width="50%" title="Release">
                <el-form :model="uploadForm" label-width="150px">
                    <el-form-item label="Server Name" required>
                        <el-input v-model="uploadForm.serverName" disabled></el-input>
                    </el-form-item>
                    <el-form-item label="Document" required>
                        <el-input v-model="uploadForm.doc" type="textarea" row="5"></el-input>
                    </el-form-item>
                    <el-form-item label="File" required>
                        <el-upload :show-file-list="true" :on-change="handleFileChange" :auto-upload="false"
                            action="/upload">
                            <el-button slot="trigger" size="small">Choose File</el-button>
                        </el-upload>
                    </el-form-item>
                </el-form>
                <span slot="footer">
                    <div style="display: flex;align-items: center;justify-content: center;">
                        <el-button type="primary" @click="uploadVisible=false">Close</el-button>
                        <el-button type="success" @click="uploadFile">Upload</el-button>
                    </div>
                </span>
            </el-dialog>
            <el-dialog append-to-body :visible="configVisible" title="Server Configuration" width="60%">
                <el-form :model="config" label-width="100px">
                    <el-form-item label="Name">
                        <el-input v-model="config.Name" disabled></el-input>
                    </el-form-item>
                    <el-form-item label="Host">
                        <el-input v-model="config.Host"></el-input>
                    </el-form-item>
                    <el-form-item label="Port">
                        <el-input v-model="config.Port" disabled></el-input>
                    </el-form-item>
                    <el-form-item label="Type">
                        <el-input v-model="config.Type" disabled></el-input>
                    </el-form-item>
                    <el-form-item label="Static Path">
                        <el-input v-model="config.StaticPath"></el-input>
                    </el-form-item>
                    <el-form-item label="Storage">
                        <el-input v-model="config.Storage"></el-input>
                    </el-form-item>
                </el-form>
                <span slot="footer">
                    <div style="display: flex;align-items: center;justify-content: center;">
                        <el-button type="primary" @click="configVisible=false">Close</el-button>
                        <el-button type="success" @click="previewSubServer()">Preivew</el-button>
                        <el-button type="danger" @click="uploadConfig()">Upload</el-button>
                    </div>
                </span>
            </el-dialog>

            <el-dialog append-to-body :visible="createServerVisible" title="Create Server" width="60%">
                <el-form :model="config" label-width="100px">
                    <el-form-item label="Name">
                        <el-input v-model="createServerName"></el-input>
                    </el-form-item>
                </el-form>
                <span slot="footer">
                    <div style="display: flex;align-items: center;justify-content: center;">
                        <el-button type="primary" @click="createServerVisible=false">Close</el-button>
                        <el-button type="success" @click="createServer()">Create</el-button>
                    </div>
                </span>
            </el-dialog>

            <el-dialog append-to-body :visible="releaseVisible" title="Release Server" width="60%">
                <el-select v-model="selectRelease" placeholder="请选择" style="width: 100%;">
                    <el-option v-for="item in packageList" :key="item.Hash"
                        :label="serverName + '_' + item.Hash + '.tar.gz'"
                        :value="serverName + '_' + item.Hash + '.tar.gz'">
                        <span style="float: left">{{ serverName }}</span>
                        <span style="float: right;" @click="DeletePackage(item.Hash)">
                            <i class="el-icon-remove" style="color: crimson;cursor: pointer;"></i>
                        </span>
                        <span style="float: right; color: #8492a6; font-size: 13px">
                            {{ item.Hash }} &nbsp;
                        </span>
                    </el-option>
                </el-select>
                <span slot="footer">
                    <div style="display: flex;align-items: center;justify-content: center;">
                        <el-button type="primary" @click="releaseVisible = false">Close</el-button>
                        <el-button type="success" @click="restartServer()">Release</el-button>
                        <el-button type="danger" @click="uploadVisible = true">Upload</el-button>
                    </div>
                </span>

            </el-dialog>

        </el-col>
    </div>

    <script>
        const HttpReq = axios.create({
            // baseURL, // api的base_url
            timeout: 15000, // 请求超时时间,
            method: "post",
            baseURL: '/simpserver/'
        });
        HttpReq.interceptors.response.use(resp => {
            if (resp.data.Code != 0) {
                console.log('resp.data.Message |', resp.data.Message);
                // this.$message.error(resp.data.Message)
            }
            return resp.data;
        })

        HttpReq.interceptors.request.use(config => {
            const tkn = localStorage.getItem("token")
            console.log("token", tkn);
            config.headers["token"] = tkn
            return config;
        })

        const API = {
            UploadServer: function (data, url = "/uploadServer") {
                return HttpReq({
                    url, data
                })
            },
            RestartServer: function (data, url = "/restartServer") {
                return HttpReq({
                    url,
                    data
                })
            },
            GetServerList: function (url = "/getServers") {
                return HttpReq({
                    url,
                })
            },
            GetServerPackageList: function (data, url = "/getServerPackageList") {
                return HttpReq({
                    url,
                    data
                })
            },
            CheckServer: function (data, url = "/checkServer") {
                return HttpReq({
                    url,
                    data
                })
            },
            CreateServer: function (data, url = "/createServer") {
                return HttpReq({
                    url,
                    data
                })
            },
            CheckConfig: function (data, url = "/checkConfig") {
                return HttpReq({
                    url,
                    data
                })
            },
            DeleteAllPackages: function (data, url = "/deleteAllPackage") {
                return HttpReq({
                    url,
                    data
                })
            },
            DeletePackage: function (data, url = "/deletePackage") {
                return HttpReq({
                    url,
                    data
                })
            },
            ShutDownServer: function (data, url = "/shutdownServer") {
                return HttpReq({
                    url,
                    data
                })
            },
            GetLogger: function (data, url = "/getServerLog") {
                return HttpReq({
                    url,
                    data
                })
            },
            GetApiJson: function (data, url = "/getApiJson") {
                return HttpReq({
                    url,
                    data
                })
            },
            GetDoc: function (data, url = "/getDoc") {
                return HttpReq({
                    url,
                    data
                })
            },
            GetLogList: function (data, url = "/getLogList") {
                return HttpReq({
                    url,
                    data
                })
            },
            CoverConfig: function (data, url = "/coverConfig") {
                return HttpReq({
                    url,
                    data
                })
            },
            GetMainLogList: function (data, url = "/main/getLogList") {
                return HttpReq({
                    url,
                    data
                })
            },
            GetMainLogger: function (data, url = "/main/getServerLog") {
                return HttpReq({
                    url,
                    data
                })
            },
        }
        new Vue({
            el: '#app',
            data: {
                uploadForm: {
                    serverName: '',
                    file: null,
                    doc: ''
                },
                serverList: [],
                packageList: [],
                serverName: '',
                uploadVisible: false,
                status: {
                    pid: 0,
                    status: false,
                },
                configVisible: false,
                config: {
                    Name: "",
                    Port: 0,
                    Type: "",
                    StaticPath: "",
                    Storage: "",
                    Proxy: null,
                    Host:"",
                },
                createServerVisible: false,
                createServerName: '',
                releaseVisible: false,
                selectRelease: '',
                logger: '',
                loggerList: [],
                loggerFile: '',
                pattern: '',
                activeName: 'logger',
                apis: '', // API接口 由gin生成
                doc: '',

                mainLogList: [],
            },
            methods: {
                handleFileChange(file) {
                    this.uploadForm.file = file.raw;
                },
                async uploadFile() {
                    const loading = this.$loading({
                        lock: true,
                        text: 'Loading',
                        spinner: 'el-icon-loading',
                        background: 'rgba(0, 0, 0, 0.7)'
                    });
                    const formData = new FormData();
                    formData.append('serverName', this.uploadForm.serverName);
                    formData.append('file', this.uploadForm.file);
                    formData.append('doc', this.uploadForm.doc);
                    const data = await API.UploadServer(formData)
                    this.uploadForm.file = null;
                    if (data.Code) {
                        this.$message({
                            type: 'error',
                            message: '上传失败' + resp.Message
                        });
                    } else {
                        this.$message({
                            type: 'success',
                            message: '上传成功'
                        });
                        this.uploadVisible = false
                    }
                    this.getServerPackageList(this.serverName)
                    loading.close()
                },
                async restartServer() {
                    if (!this.selectRelease || !this.serverName) {
                        this.$message({
                            type: 'info',
                            message: '发布失败！请选择指定的服务和发布包'
                        });
                        return
                    }
                    const loading = this.$loading({
                        lock: true,
                        text: 'Loading',
                        spinner: 'el-icon-loading',
                        background: 'rgba(0, 0, 0, 0.7)'
                    });
                    const formData = new FormData();
                    formData.append('fileName', this.selectRelease);
                    formData.append('serverName', this.serverName);

                    const resp = await API.RestartServer(formData)
                    this.status = {
                        status: resp.Data.status ? 'online' : 'offline',
                        pid: resp.Data.pid
                    }
                    if (resp.Code) {
                        this.$message({
                            type: 'error',
                            message: '发布失败' + resp.Message
                        });
                    } else {
                        this.$message({
                            type: 'success',
                            message: '发布成功'
                        });
                        this.releaseVisible = false
                    }
                    loading.close()
                },
                async fetchServerList() {
                    const resp = await API.GetServerList();
                    this.serverList = resp.Data || [];
                },
                async getServerPackageList(serverName) {
                    const formData = new FormData();
                    formData.append('serverName', serverName);
                    const vm = this;
                    const resp = await API.GetServerPackageList(formData)
                    vm.packageList = resp.Data || [];
                    if (vm.packageList.length) {
                        const resp = await API.CheckServer(formData)
                        const ret = resp.Data;
                        vm.status = {
                            status: ret.status ? 'online' : 'offline',
                            pid: ret.pid
                        }
                    }
                },
                async handleOpen(serverName, keyPath) {
                    this.serverName = serverName;
                    await this.getServerPackageList(serverName)
                    this.uploadForm.serverName = serverName;
                },
                async showConfig() {
                    const formData = new FormData();
                    formData.append('serverName', this.serverName);
                    const resp = await API.CheckConfig(formData)
                    this.config = resp.Data.Server
                    this.configVisible = true
                },
                async DeleteAllPackages() {
                    if (!this.serverName) {
                        this.$message.error("请先选择服务")
                        return
                    }
                    this.$confirm('此操作将永久删除所有目录, 是否继续?', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(async () => {
                        const formData = new FormData();
                        formData.append('serverName', this.serverName);
                        const data = await API.DeleteAllPackages(formData)
                        this.$message({
                            type: 'success',
                            message: '删除成功!'
                        });
                    }).catch(() => {
                        this.$message({
                            type: 'info',
                            message: '已取消删除'
                        });
                    });
                },
                async createServer() {
                    const formData = new FormData();
                    formData.append('serverName', this.createServerName);
                    const data = await API.CreateServer(formData)
                    this.$message({
                        type: 'success',
                        message: '添加成功!'
                    });
                    this.createServerVisible = false
                },
                async DeletePackage(hash) {
                    this.$confirm('确认删除该发布包?', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(async () => {
                        const formData = new FormData();
                        const fileName = `${this.serverName}_${hash}.tar.gz`
                        formData.append('serverName', this.serverName);
                        formData.append('fileName', fileName);
                        const rest = await API.DeletePackage(formData)
                        if (rest.Code) {
                            this.$message.error("删除失败" + rest.Message)
                            return
                        }
                        this.$message.success("删除成功")
                        await this.getServerPackageList(this.serverName)
                        this.selectRelease = ""
                    }).catch(() => {
                        this.$message.info("已取消删除")
                    })
                },
                async GetServerLogger() {
                    if (this.serverName) {
                        const formData = new FormData();
                        formData.append('serverName', this.serverName);
                        formData.append('fileName', this.loggerFile);
                        formData.append('pattern', this.pattern);
                        const rest = await API.GetLogger(formData)
                        this.logger = rest.Data.split("\n");
                    } else {
                        const formData = new FormData();
                        formData.append('logFile', this.loggerFile);
                        formData.append('pattern', this.pattern);
                        const rest = await API.GetMainLogger(formData)
                        this.logger = rest.Data.split("\n");
                    }
                },
                async initLogger() {
                    this.loggerList = [];
                    this.loggerFile = '';
                    const formData = new FormData();
                    formData.append('serverName', this.serverName);
                    const data = await API.GetLogList(formData);
                    this.loggerList = data.Data || [];
                    this.loggerFile = this.loggerList.length ? this.loggerList[0] : ''
                },
                previewSubServer() {
                    const conf = this.config
                    const target = `http://localhost:${conf.Port}/${conf.StaticPath}/`
                    // http://localhost:8511/web/
                    // http://localhost:8511/web/
                    window.open(target)
                },
                async ShutDownServer() {
                    const formData = new FormData();
                    formData.append('serverName', this.serverName);
                    const data = await API.ShutDownServer(formData);
                    if (data.Code) {
                        this.$message({
                            type: 'error',
                            message: '关闭失败!' + data.Message
                        });
                        return;
                    }
                    this.$message({
                        type: 'success',
                        message: '成功关闭节点!'
                    });
                    this.getServerPackageList(this.serverName)
                },
                async uploadConfig() {
                    const body = this.MapKeysToUpper({
                        ServerName: this.serverName,
                        Conf: {
                            Server: this.config
                        }
                    })
                    const ret = await API.CoverConfig(body)
                    if (ret.Data) {
                        this.$message({
                            type: 'error',
                            message: '覆盖失败!' + data.Message
                        });
                        return;
                    }
                    this.$message({
                        type: 'success',
                        message: '覆盖成功!'
                    });
                    this.configVisible = false
                },
                MapKeysToUpper(obj) {
                    var newObj = {};
                    for (var key in obj) {
                        if (typeof key === 'string') {
                            newObj[key.charAt(0).toUpperCase() + key.slice(1)] = obj[key];
                        } else {
                            newObj[key] = obj[key];
                        }
                    }
                    return newObj;
                },
                async GetMainLogList() {
                    this.serverName = ""
                    const List = await API.GetMainLogList()
                    const Data = List.Data;
                    this.mainLogList = Data;
                    this.loggerFile = Data.length ? Data[0] : ''
                }
            },
            mounted() {
                // Fetch initial server list
                this.fetchServerList();
                this.GetMainLogList()
            },
            watch: {
                activeName: async function (val) {
                    if (val == 'api') {
                        const formData = new FormData();
                        formData.append('serverName', this.serverName);
                        const data = await API.GetApiJson(formData)
                        this.apis = JSON.parse(data.Data)
                    }
                    if (val == 'doc') {
                        const formData = new FormData();
                        formData.append('serverName', this.serverName);
                        const data = await API.GetDoc(formData)
                        this.doc = data.Data
                    }
                    if (val == "logger") {
                        await this.initLogger()
                        // const 
                    }
                },
                serverName: async function () {
                    this.doc = ''
                    this.apis = [];
                    this.logger = ''
                    this.packageList = []
                    this.activeName = 'logger'
                    this.pattern = ''
                    //
                    await this.initLogger()
                },
                releaseVisible:function(newVal){
                    if(newVal){
                        this.selectRelease = ''
                        this.uploadForm= {
                            serverName: this.serverName,
                            file: null,
                            doc: ''
                        }
                    }
                }
            },
        });
    </script>
</body>

</html>